<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>PSoC WS2812Bdriver by betaEncoder</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>PSoC WS2812B driver Component</h1>
        <p>Neo Pixel LED WS2812 を駆動するためのUDBを使ったPSoCコンポーネントの使い方について．<br>
		(PSoC4で動作を確認していますが，3や5でも動くと思います．)<br>
		<img src="img/instance.png"></p>

        <p class="view"><a href="https://github.com/betaEncoder/PSoC_WS2812Bdriver">View the Project on GitHub <small>betaEncoder/PSoC_WS2812Bdriver</small></a></p>


        <ul>
          <li><a href="https://github.com/betaEncoder/PSoC_WS2812Bdriver/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/betaEncoder/PSoC_WS2812Bdriver/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/betaEncoder/PSoC_WS2812Bdriver">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3>コンポーネントをダウンロード</h3>
<p>PSoC Creator で使用するコンポーネントをダウンロードには<a href="https://github.com/betaEncoder/PSoC_WS2812Bdriver/releases"><b> ここからWS2812Driver.cycpmpをダウンロード </b></a>して下さい．</p>
<hr>
<h3>コンポーネントをインポートする</h3>
<p>PSoC Creator の左側にある Workspace Explorer の Component タブを開きます．<br>
<img src ="img/01_select_components_tab.png"><br>
<br>
Workspace Explorer 上で右クリックし， Import Component... を開きます．<br>
Import from archive を選択し，ダウンロードしたファイルを読み込みます．<br>
<img src="img/02_import_component.png"><br>
<br>
すると，PSoC Creator の右側にある Component Catalog の Default タブの中にインポートしたコンポーネントがあるので，デザインにドラッグ&ドロップできるようになっています．<br>
<img src="img/03_component_catalog.png"><br>
</p>
<hr>
<h3>クロックの設定</h3>
<p>WS2812へ入力するパルスは決まった時間幅を持つ必要があるので，WS2812 driver に供給するクロックも決まった周波数である必要があります．<br>
このコンポーネントでは20MHzをCLKに入れる必要があるので，HFCLKはその倍の40MHz以上としなければなりません．<br>
この理由からPSoC4ではこのような設定になります．<br>
(外部クロックが利用できるならEXTCLKを利用するのがベターです)<br>
<a href="img/04_clock_setting.png"><img src="img/04_clock_setting.png"></a></p>
<hr>
<h3>デザイン</h3>
<p>たとえば，こんな感じに接続するとよいでしょう．<br>
<img src="img/05_design.png"><br>
<br>
WS2812BdriverのFIFO_EMPTYピンは内部のFIFOが空になるとHになります．この立ち上がりエッジを利用して割り込みをかけることで，連続したデータを流すことができます．<br>
FIFO_EMPTYがHのとき，FIFOへはWS2812driver_write2fifo()を使って最大で9バイトを流しこむことができます．<br>
また，BUSYピンはパルスの出力処理中にHになります．FIFOが空になっても新しいデータが書き込まれない場合に処理が完了し，L出力になります．<br>
BUSYピン出力を使って周期が50usのカウンタを回すことで，50usのリセットパルスの出力に役立ちます．<br>
今回はカウンタへ入力するクロックを5MHzとしたので，カウンタの設定はこんな感じが良いでしょう．<br>
Period=249で50usになります．<br>
<img src="img/06_counter_period.png"><br>
<br>
ワンショット動作にしたいのでAdvanceタブはこんな感じに．<br>
<img src="img/07_counter_one_shot.png"><br></p>
<hr>
<h3>コーディングのtips</h3>
<p>WS2812へ送り込むバイト列は，GRBの順で送り込みます．<br>
そこで，構造体を利用してドライバを叩くことでコードがすっきりします．</p>
<pre><code>typedef struct _RGB_tag{
	unsigned char g;
	unsigned char r;
	unsigned char b;
} rgb_tag;

void hoge(){
	rgb_tag rgb[] = { {hoge1, hoge2, hoge3} , {foo1, foo2, foo3}, {bar1, bar2, bar3} };
	WS2812driver_1_write2fifo((unsigned char*)rgb, 9);
}
</code></pre>
     </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/betaEncoder">betaEncoder</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
